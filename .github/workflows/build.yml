name: Build ImmortalWrt (x86_64 rootfs2G + homeproxy/ddns/docker)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Choose ImmortalWrt branch"
        required: true
        default: "openwrt-23.05"
        type: choice
        options:
          - openwrt-23.05
          - master

  push:
    paths:
      - ".github/workflows/build.yml"
      - "config/**"
      - "scripts/**"

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout this repo (workflow/config/scripts)
        uses: actions/checkout@v4

      - name: Show selected branch
        run: |
          echo "Selected branch: ${{ github.event.inputs.branch || 'openwrt-23.05 (default for push)' }}"

      - name: Free disk space
        run: |
          sudo -E apt-get -y purge azure-cli google-cloud-cli llvm* firefox powershell mono-devel || true
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
            file wget curl jq

      - name: Clone ImmortalWrt (branch selectable)
        run: |
          BRANCH="${{ github.event.inputs.branch }}"
          if [ -z "$BRANCH" ]; then BRANCH="openwrt-23.05"; fi
          echo "Cloning ImmortalWrt branch: $BRANCH"
          git clone -b "$BRANCH" --depth=1 https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          echo "IMMORTALWRT_DIR=$PWD" >> $GITHUB_ENV
          echo "IMMORTALWRT_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "Branch check:"
          git branch --show-current
          git log -1 --oneline

      - name: Update & install feeds
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load config (rootfs size fixed in config file)
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          cp ../config/immortalwrt-x86_64-rootfs2g.config .config
          make defconfig
          echo "===== Key config lines ====="
          egrep "TARGET_|ROOTFS_PARTSIZE|homeproxy|sing-box|ddns|docker|dockerman|firewall4|nftables|kmod-tun" .config || true

      - name: Download package sources
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          make download -j$(nproc)
          find dl -size -1024c -exec ls -l {} \; || true

      - name: Build firmware
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          make -j$(nproc) V=s

      - name: Collect artifacts
        run: |
          mkdir -p output
          cp -r "${{ env.IMMORTALWRT_DIR }}/bin/targets/"*/* output/ || true
          echo "===== Output files ====="
          find output -maxdepth 3 -type f | sed 's#^#- #'

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.IMMORTALWRT_BRANCH }}-x86_64-rootfs2g
          path: output
