name: Build ImmortalWrt (x86_64 rootfs2G + homeproxy/ddns/docker) + Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
      - name: Checkout this repo (workflow/config/build.env)
        uses: actions/checkout@v4

      - name: Load build variables from build.env
        run: |
          set -e
          if [ ! -f "$GITHUB_WORKSPACE/build.env" ]; then
            echo "ERROR: build.env not found in repo root."
            exit 1
          fi

          echo "=== build.env ==="
          cat "$GITHUB_WORKSPACE/build.env"

          # 导入变量
          set -a
          source "$GITHUB_WORKSPACE/build.env"
          set +a

          # 写入 GITHUB_ENV 供后续 steps 使用
          echo "IMMORTALWRT_REPO=$IMMORTALWRT_REPO" >> $GITHUB_ENV
          echo "IMMORTALWRT_BRANCH=$IMMORTALWRT_BRANCH" >> $GITHUB_ENV
          echo "CONFIG_FILE=$CONFIG_FILE" >> $GITHUB_ENV

          echo "Repo:   $IMMORTALWRT_REPO"
          echo "Branch: $IMMORTALWRT_BRANCH"
          echo "Config: $CONFIG_FILE"

      - name: Initialization environment (P3TERX style)
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: Asia/Shanghai
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* \
            /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force || true

          sudo -E apt-get -qq update
          sudo -E apt-get -qq install \
            ack antlr3 asciidoc autoconf automake autopoint \
            binutils bison build-essential bzip2 ccache cmake cpio curl \
            device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev \
            libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
            libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build \
            p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev

          sudo -E apt-get -qq autoremove --purge || true
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ" || true

          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          df -hT

      - name: Clone ImmortalWrt source code to /workdir (from build.env)
        working-directory: /workdir
        run: |
          set -e
          echo "Cloning: $IMMORTALWRT_REPO  branch=$IMMORTALWRT_BRANCH"
          git clone -b "$IMMORTALWRT_BRANCH" --depth=1 "$IMMORTALWRT_REPO" immortalwrt
          ln -sf /workdir/immortalwrt "$GITHUB_WORKSPACE/immortalwrt"

          echo "IMMORTALWRT_DIR=$GITHUB_WORKSPACE/immortalwrt" >> $GITHUB_ENV

          cd "$GITHUB_WORKSPACE/immortalwrt"
          git branch --show-current
          git log -1 --oneline
          df -hT .

      - name: Update feeds
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: ./scripts/feeds update -a

      - name: Install feeds
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: ./scripts/feeds install -a

      - name: Load config (absolute path + self-check)
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          set -e
          echo "PWD=$(pwd)"
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "IMMORTALWRT_DIR=${{ env.IMMORTALWRT_DIR }}"
          echo "CONFIG_FILE=${{ env.CONFIG_FILE }}"

          echo "=== list workspace root ==="
          ls -lah "$GITHUB_WORKSPACE" || true

          echo "=== list config dir (normal) ==="
          ls -lah "$GITHUB_WORKSPACE/config" || true

          echo "=== list config dir (show hidden chars) ==="
          ls -lb "$GITHUB_WORKSPACE/config" || true

          # 关键：用绝对路径复制，不再依赖 ../
          cp "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" .config

          make defconfig
          echo "===== Key config lines ====="
          egrep "TARGET_|ROOTFS_PARTSIZE|homeproxy|sing-box|ddns|docker|dockerman|firewall4|nftables|kmod-tun" .config || true

      - name: Download package sources
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          make download -j8
          find dl -size -1024c -exec ls -l {} \; || true
          find dl -size -1024c -exec rm -f {} \; || true

      - name: Compile firmware (capture log + fallback)
        id: compile
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          set +e
          echo -e "$(nproc) thread compile"
          make -j$(nproc) 2>&1 | tee build.log
          RET=${PIPESTATUS[0]}

          if [ $RET -ne 0 ]; then
            echo "Parallel build failed (code=$RET), retry with -j1"
            make -j1 2>&1 | tee -a build.log
            RET=${PIPESTATUS[0]}
          fi

          if [ $RET -ne 0 ]; then
            echo "Retry with -j1 V=s"
            make -j1 V=s 2>&1 | tee -a build.log
            RET=${PIPESTATUS[0]}
          fi

          if [ $RET -ne 0 ]; then
            echo "===== LAST 200 LINES OF build.log ====="
            tail -n 200 build.log || true
            echo "===== df -h ====="
            df -h || true
            echo "===== free -h ====="
            free -h || true
            exit $RET
          fi

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ env.IMMORTALWRT_BRANCH }}
          path: ${{ env.IMMORTALWRT_DIR }}/build.log
          if-no-files-found: ignore

      - name: Organize firmware output (robust)
        id: organize
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          set -e
          BASE="${{ env.IMMORTALWRT_DIR }}/bin/targets"
          echo "Targets base: $BASE"

          if [ ! -d "$BASE" ]; then
            echo "ERROR: $BASE does not exist."
            ls -lah "${{ env.IMMORTALWRT_DIR }}/bin" || true
            exit 2
          fi

          FIRMWARE_DIR="$(find "$BASE" -mindepth 2 -maxdepth 2 -type d | head -n 1)"
          if [ -z "$FIRMWARE_DIR" ]; then
            echo "ERROR: No firmware directory found under $BASE"
            find "$BASE" -maxdepth 3 -type d -print || true
            exit 2
          fi

          cd "$FIRMWARE_DIR"
          rm -rf packages || true
          echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          echo "Firmware dir: $PWD"
          ls -lah

      - name: Upload firmware artifacts (targets only)
        if: steps.organize.outputs.status == 'success' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.IMMORTALWRT_BRANCH }}-x86_64-rootfs2g
          path: ${{ env.FIRMWARE_DIR }}

      - name: Generate release tag
        id: tag
        if: steps.organize.outputs.status == 'success' && !cancelled()
        run: |
          echo "RELEASE_TAG=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "RELEASE_NAME=ImmortalWrt-${{ env.IMMORTALWRT_BRANCH }}-x86_64-rootfs2g" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Create GitHub Release and upload firmware
        if: steps.tag.outputs.status == 'success' && !cancelled()
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }} ${{ env.RELEASE_TAG }}
          body: |
            Branch: ${{ env.IMMORTALWRT_BRANCH }}
            rootfs: 2G (2048MB)
            Includes: LuCI(https), HomeProxy(sing-box), DDNS, Docker/Dockerman
          files: |
            ${{ env.FIRMWARE_DIR }}/*
