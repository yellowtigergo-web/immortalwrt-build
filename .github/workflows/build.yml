name: Build ImmortalWrt (x86_64 rootfs2G + homeproxy/ddns/docker) + Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Choose ImmortalWrt branch"
        required: true
        default: "openwrt-23.05"
        type: choice
        options:
          - openwrt-23.05
          - master

#  push:
#    paths:
#      - ".github/workflows/build.yml"
#      - "config/**"
#      - "scripts/**"

jobs:
  build:
    runs-on: ubuntu-22.04

    # 关键：创建 Release / 上传附件需要写权限
    permissions:
      contents: write

    steps:
      - name: Checkout this repo (workflow/config/scripts)
        uses: actions/checkout@v4

      - name: Initialization environment (P3TERX style)
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: Asia/Shanghai
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* \
            /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force || true

          sudo -E apt-get -qq update
          sudo -E apt-get -qq install \
            ack antlr3 asciidoc autoconf automake autopoint \
            binutils bison build-essential bzip2 ccache cmake cpio curl \
            device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev \
            libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
            libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build \
            p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev

          sudo -E apt-get -qq autoremove --purge || true
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ" || true

          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          df -hT

      - name: Clone ImmortalWrt source code to /workdir (branch selectable)
        working-directory: /workdir
        run: |
          BRANCH="${{ github.event.inputs.branch }}"
          if [ -z "$BRANCH" ]; then BRANCH="openwrt-23.05"; fi
          echo "Cloning branch: $BRANCH"

          git clone -b "$BRANCH" --depth=1 https://github.com/immortalwrt/immortalwrt.git openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

          echo "IMMORTALWRT_DIR=$GITHUB_WORKSPACE/openwrt" >> $GITHUB_ENV
          echo "IMMORTALWRT_BRANCH=$BRANCH" >> $GITHUB_ENV

          cd $GITHUB_WORKSPACE/openwrt
          echo "Branch check:"
          git branch --show-current
          git log -1 --oneline
          df -hT .

      - name: Update feeds
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          ./scripts/feeds update -a

      - name: Install feeds
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          ./scripts/feeds install -a

      - name: Apply DIY script (optional)
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          if [ -f "../scripts/diy.sh" ]; then
            chmod +x ../scripts/diy.sh
            ../scripts/diy.sh
          else
            echo "No scripts/diy.sh found, skipping."
          fi

      - name: Load config (rootfs size fixed in config file)
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          cp ../config/immortalwrt-x86_64-rootfs2g.config .config
          make defconfig
          echo "===== Key config lines ====="
          egrep "TARGET_|ROOTFS_PARTSIZE|homeproxy|sing-box|ddns|docker|dockerman|firewall4|nftables|kmod-tun" .config || true

      - name: Download package sources
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          make download -j8
          find dl -size -1024c -exec ls -l {} \; || true
          find dl -size -1024c -exec rm -f {} \; || true

      # 编译：先并行，失败自动降级（P3TERX 风格）
      - name: Compile firmware
        id: compile
        working-directory: ${{ env.IMMORTALWRT_DIR }}
        run: |
          echo -e "$(nproc) thread compile"
          set +e
          make -j$(nproc)
          RET=$?
          if [ $RET -ne 0 ]; then
            echo "Parallel build failed, retry with -j1"
            make -j1
            RET=$?
          fi
          if [ $RET -ne 0 ]; then
            echo "Retry with -j1 V=s"
            make -j1 V=s
            RET=$?
          fi
          set -e
          if [ $RET -ne 0 ]; then
            echo "Build failed."
            exit $RET
          fi
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Check space usage
        if: (!cancelled())
        run: df -hT

      - name: Organize firmware output (targets only)
        id: organize
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          cd "${{ env.IMMORTALWRT_DIR }}/bin/targets/"*/*
          rm -rf packages || true
          echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          echo "Firmware dir: $PWD"
          ls -lah

      # 保底：上传 targets 产物到 Artifacts
      - name: Upload firmware artifacts
        if: steps.organize.outputs.status == 'success' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.IMMORTALWRT_BRANCH }}-x86_64-rootfs2g
          path: ${{ env.FIRMWARE_DIR }}

      # 生成 Release tag
      - name: Generate release tag
        id: tag
        if: steps.organize.outputs.status == 'success' && !cancelled()
        run: |
          echo "RELEASE_TAG=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "RELEASE_NAME=ImmortalWrt-${{ env.IMMORTALWRT_BRANCH }}-x86_64-rootfs2g" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      # 创建 Release + 上传固件
      - name: Create GitHub Release and upload firmware
        if: steps.tag.outputs.status == 'success' && !cancelled()
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }} ${{ env.RELEASE_TAG }}
          body: |
            Branch: ${{ env.IMMORTALWRT_BRANCH }}
            rootfs: 2G (2048MB)
            Includes: LuCI(https), HomeProxy(sing-box), DDNS, Docker/Dockerman
            Note: Docker data-root should be moved to external disk after install.
          files: |
            ${{ env.FIRMWARE_DIR }}/*

      # （可选）把 config 也作为附件传上去，方便回溯
      - name: Upload build config (optional)
        if: steps.tag.outputs.status == 'success' && !cancelled()
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            ${{ github.workspace }}/config/immortalwrt-x86_64-rootfs2g.config
